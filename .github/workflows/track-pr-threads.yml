name: Sync PR Open Threads
on:
  schedule:
    - cron: '0 */4 * * *'
  pull_request_review_comment:
    types: [created, deleted]
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number (leave blank for all open PRs)'
        required: false

jobs:
  sync:
    # Adding concurrency is the final layer of protection.
    # If two events DO happen at once, GitHub will cancel the first one.
    concurrency:
      group: sync-threads-${{ github.event.pull_request.id || 'bulk' }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Calculate and Sync
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
          ORG: "FinOps-Open-Cost-and-Usage-Spec"
          PROJECT_NUM: 7
          FIELD_NAME: "PR Open Threads"
          SINGLE_PR: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
        run: |
          # 1. Fetch Project and Field IDs
          PROJ_DATA=$(gh api graphql -f query='
            query($org: String!, $p_num: Int!) {
              organization(login: $org) {
                projectV2(number: $p_num) {
                  id
                  fields(first: 50) { nodes { ... on ProjectV2Field { id name } } }
                }
              }
            }' -f org="$ORG" -F p_num=$PROJECT_NUM)

          PROJECT_ID=$(echo "$PROJ_DATA" | jq -r '.data.organization.projectV2.id')
          FIELD_ID=$(echo "$PROJ_DATA" | jq -r --arg NAME "$FIELD_NAME" '.data.organization.projectV2.fields.nodes[] | select(.name==$NAME) | .id')

          if [ -z "$FIELD_ID" ] || [ "$FIELD_ID" == "null" ]; then
            echo "Error: Field '$FIELD_NAME' not found in Project #$PROJECT_NUM"
            exit 1
          fi

          # 2. Identify PRs
          if [ -n "$SINGLE_PR" ]; then
            PR_LIST=($SINGLE_PR)
          else
            PR_LIST=($(gh pr list --state open --json number --jq '.[].number'))
          fi

          # 3. Loop and Update
          for NUM in "${PR_LIST[@]}"; do
            echo "--- Processing PR #$NUM ---"
            
            PR_DATA=$(gh api graphql -f query='
              query($org: String!, $repo: String!, $num: Int!) {
                repository(owner: $org, name: $repo) {
                  pullRequest(number: $num) {
                    id
                    reviewThreads(last: 100) { nodes { isResolved } }
                  }
                }
              }' -f org="$ORG" -f repo="${{ github.event.repository.name }}" -F num=$NUM)

            PR_NODE_ID=$(echo "$PR_DATA" | jq -r '.data.repository.pullRequest.id')
            if [ -z "$PR_NODE_ID" ] || [ "$PR_NODE_ID" == "null" ]; then continue; fi

            COUNT=$(echo "$PR_DATA" | jq -r '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length // 0')

            ITEM_ID=$(gh api graphql -f query='
              query($project: ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(last: 100) { nodes { id content { ... on PullRequest { id } } } }
                  }
                }
              }' -f project="$PROJECT_ID" --jq ".data.node.items.nodes[] | select(.content.id == \"$PR_NODE_ID\") | .id")

            if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
              gh api graphql -f query='
                mutation($project: ID!, $item: ID!, $field: ID!, $value: Float!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $project, itemId: $item, fieldId: $field, value: { number: $value }
                  }) { clientMutationId }
                }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$FIELD_ID" -F value=$COUNT
              echo "Successfully updated PR #$NUM to $COUNT."
            fi
          done
