name: Sync Approval Count to Project

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  pull_request_review:
    types: [submitted, edited, dismissed]
  issue_comment:
    types: [created]

jobs:
  sync_approvals:
    if: github.event.issue.pull_request || github.event.pull_request
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PROJECT_PAT }}
      ORG: "FinOps-Open-Cost-and-Usage-Spec"
      PROJECT_NUM: 7

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Sync Approvals
        run: |
          set -e

          # 1. Determine PR URL and Node ID
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            PR_URL="${{ github.event.issue.pull_request.html_url }}"
          else
            PR_URL="${{ github.event.pull_request.html_url }}"
          fi
          
          PR_NODE_ID=$(gh pr view "$PR_URL" --json id --jq '.id')
          echo "Processing PR: $PR_URL (Node ID: $PR_NODE_ID)"

          # 2. Get Unique Approval Count
          APPROVAL_COUNT=$(gh pr view "$PR_URL" --json reviews | \
            jq '.reviews | group_by(.author.login) | map(select(.[-1].state == "APPROVED")) | length')
          echo "Current Unique Approvals: $APPROVAL_COUNT"

          # 3. Get Project ID and Field ID
          # Removed the unused $project variable that caused the "anonymous query" error
          PROJECT_DATA=$(gh api graphql -f query='
            query($org: String!, $num: Int!) {
              organization(login: $org) {
                projectV2(number: $num) {
                  id
                  fields(first: 50) {
                    nodes {
                      ... on ProjectV2Field { id name }
                    }
                  }
                }
              }
            }' -f org="$ORG" -F num=$PROJECT_NUM)

          PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.data.organization.projectV2.id')
          
          # This specifically looks for the "Approvals" field ID
          FIELD_ID=$(echo "$PROJECT_DATA" | jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Approvals") | .id')

          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" == "null" ]; then
             echo "Error: Could not find Project #$PROJECT_NUM"
             exit 1
          fi
          
          if [ -z "$FIELD_ID" ] || [ "$FIELD_ID" == "null" ]; then
             echo "Error: Could not find a field named 'Approvals'. Please check the field name in your project."
             exit 1
          fi

          # 4. Get the Item ID for this PR
          ITEM_ID=$(gh api graphql -f query='
            query($pr_id: ID!) {
              node(id: $pr_id) {
                ... on PullRequest {
                  projectItems(first: 20) {
                    nodes {
                      id
                      project { id }
                    }
                  }
                }
              }
            }' -f pr_id="$PR_NODE_ID" | \
            jq -r --arg PROJ_ID "$PROJECT_ID" '.data.node.projectItems.nodes[]? | select(.project.id == $PROJ_ID) | .id')

          # 5. Add to project if it's missing
          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" == "null" ]; then
            echo "PR not in project. Adding..."
            ITEM_ID=$(gh api graphql -f query='
              mutation($project: ID!, $content: ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                  item { id }
                }
              }' -f project="$PROJECT_ID" -f content="$PR_NODE_ID" | jq -r '.data.addProjectV2ItemById.item.id')
          fi

          # 6. Update the Field
          # Using Float! because GraphQL expects numbers to be passed as Floats/Ints
          gh api graphql -f query='
            mutation($project: ID!, $item: ID!, $field: ID!, $value: Float!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $project,
                itemId: $item,
                fieldId: $field,
                value: { number: $value }
              }) { clientMutationId }
            }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$FIELD_ID" -f value="$APPROVAL_COUNT"

          echo "Successfully updated Approvals to $APPROVAL_COUNT"
