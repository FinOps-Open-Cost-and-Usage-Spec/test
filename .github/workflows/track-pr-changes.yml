name: Sync Review Counts to Project

on:
  pull_request:
    types: 
      - opened            # PR created: Initialize counts at 0
      - synchronize       # New code pushed: Reviews often become stale/dismissed
      - reopened          # PR reopened: Refresh project state
      - review_requested  # Reviewer invited: Signals a shift in review state
  pull_request_review:
    types: 
      - submitted         # Review left: The primary driver for Approvals/Changes
      - dismissed         # Review removed: Necessary for count drops (1 -> 0)
  issue_comment:
    types: 
      - created           # Comment added: Serves as a manual "force sync"

jobs:
  sync_reviews:
    if: github.event.issue.pull_request || github.event.pull_request
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PROJECT_PAT }}
      ORG: "FinOps-Open-Cost-and-Usage-Spec"
      PROJECT_NUM: 7

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Sync and Dispatch
        run: |
          set -e

          # 1. Resolve PR Metadata
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            PR_URL="${{ github.event.issue.pull_request.html_url }}"
          else
            PR_URL="${{ github.event.pull_request.html_url }}"
          fi
          
          PR_DATA=$(gh pr view "$PR_URL" --json id,createdAt)
          PR_NODE_ID=$(echo "$PR_DATA" | jq -r '.id')
          CREATED_AT=$(echo "$PR_DATA" | jq -r '.createdAt')

          # 2. Get Calculated Counts (Latest state per user)
          REVIEWS_JSON=$(gh pr view "$PR_URL" --json reviews | jq -c '.reviews | group_by(.author.login) | map(sort_by(.submittedAt) | .[-1])')
          
          APP_COUNT=$(echo "$REVIEWS_JSON" | jq 'map(select(.state == "APPROVED")) | length')
          REQ_COUNT=$(echo "$REVIEWS_JSON" | jq 'map(select(.state == "CHANGES_REQUESTED")) | length')

          # 3. Get Project Metadata and Current Board Values
          PROJECT_QUERY=$(gh api graphql -f query='
            query($org: String!, $num: Int!) {
              organization(login: $org) {
                projectV2(number: $num) {
                  id
                  fields(first: 50) { nodes { ... on ProjectV2Field { id name } } }
                  items(first: 100) {
                    nodes {
                      id
                      content { ... on PullRequest { id } }
                      app_val: fieldValueByName(name: "Approvals") { ... on ProjectV2ItemFieldNumberValue { number } }
                      req_val: fieldValueByName(name: "Requested Changes") { ... on ProjectV2ItemFieldNumberValue { number } }
                    }
                  }
                }
              }
            }' -f org="$ORG" -F num=$PROJECT_NUM)

          PROJECT_ID=$(echo "$PROJECT_QUERY" | jq -r '.data.organization.projectV2.id')
          APP_FIELD_ID=$(echo "$PROJECT_QUERY" | jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Approvals") | .id')
          REQ_FIELD_ID=$(echo "$PROJECT_QUERY" | jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Requested Changes") | .id')
          
          ITEM_DATA=$(echo "$PROJECT_QUERY" | jq -r --arg PR_ID "$PR_NODE_ID" '.data.organization.projectV2.items.nodes[] | select(.content.id == $PR_ID)')
          ITEM_ID=$(echo "$ITEM_DATA" | jq -r '.id')
          
          # Normalize Current Values
          OLD_APP=$(echo "$ITEM_DATA" | jq -r '.app_val.number // 0 | floor')
          OLD_REQ=$(echo "$ITEM_DATA" | jq -r '.req_val.number // 0 | floor')

          # 4. CONSTRAINT: Skip only if both counts are unchanged AND it is not a manual/review event
          if [ "$OLD_APP" == "$APP_COUNT" ] && [ "$OLD_REQ" == "$REQ_COUNT" ] && [ -n "$ITEM_ID" ] && [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "No changes detected. Exiting."
            exit 0
          fi

          # 5. Add/Update Project Item
          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" == "null" ]; then
            ITEM_ID=$(gh api graphql -f query='
              mutation($project: ID!, $content: ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $content}) { item { id } }
              }' -f project="$PROJECT_ID" -f content="$PR_NODE_ID" | jq -r '.data.addProjectV2ItemById.item.id')
          fi

          # Update Board Fields
          gh api graphql -f query='
            mutation($project: ID!, $item: ID!, $field: ID!, $val: Float!) {
              updateProjectV2ItemFieldValue(input: { projectId: $project, itemId: $item, fieldId: $field, value: { number: $val } }) { clientMutationId }
            }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$APP_FIELD_ID" -F val=$APP_COUNT

          gh api graphql -f query='
            mutation($project: ID!, $item: ID!, $field: ID!, $val: Float!) {
              updateProjectV2ItemFieldValue(input: { projectId: $project, itemId: $item, fieldId: $field, value: { number: $val } }) { clientMutationId }
            }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$REQ_FIELD_ID" -F val=$REQ_COUNT

          # 6. TRIGGER THE LOGGER (Staggered)
          
          # Handle Approvals
          if [ "$OLD_APP" != "$APP_COUNT" ]; then
            ACT_APP="updated"
            [ "$APP_COUNT" -eq 0 ] && ACT_APP="cleared"
            echo "Dispatching Approvals..."
            gh api /repos/${{ github.repository }}/dispatches \
              -f event_type="project_field_updated" \
              -f client_payload[field_name]="Approvals" \
              -f client_payload[old_value]="$OLD_APP" \
              -f client_payload[new_value]="$APP_COUNT" \
              -f client_payload[content_node_id]="$PR_NODE_ID" \
              -f client_payload[created_at]="$CREATED_AT" \
              -f client_payload[changed_by]="${{ github.actor }}" \
              -f client_payload[action_type]="$ACT_APP"
            
            # Wait for Logger instance 1 to finish
            sleep 10
          fi

          # Handle Requested Changes
          if [ "$OLD_REQ" != "$REQ_COUNT" ]; then
            ACT_REQ="updated"
            [ "$REQ_COUNT" -eq 0 ] && ACT_REQ="cleared"
            echo "Dispatching Requested Changes..."
            gh api /repos/${{ github.repository }}/dispatches \
              -f event_type="project_field_updated" \
              -f client_payload[field_name]="Requested Changes" \
              -f client_payload[old_value]="$OLD_REQ" \
              -f client_payload[new_value]="$REQ_COUNT" \
              -f client_payload[content_node_id]="$PR_NODE_ID" \
              -f client_payload[created_at]="$CREATED_AT" \
              -f client_payload[changed_by]="${{ github.actor }}" \
              -f client_payload[action_type]="$ACT_REQ"
          fi
