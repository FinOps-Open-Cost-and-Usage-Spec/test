name: Log Project Field Change
on:
  repository_dispatch:
    types: [project_field_updated]

jobs:
  comment_change:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Current State (as User)
        id: fetch_state
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
          ITEM_ID: ${{ github.event.client_payload.item_node_id }}
          FIELD_NAME: ${{ github.event.client_payload.field_name }}
        run: |
          set -e

          # Query to fetch the new values from the project
          read -r -d '' QUERY << 'EOF' || true
          query($item_id: ID!) {
            node(id: $item_id) {
              ... on ProjectV2Item {
                fieldValues(first: 20) {
                  nodes {
                    ... on ProjectV2ItemFieldSingleSelectValue {
                      name
                      field { ... on ProjectV2FieldCommon { name } }
                    }
                    ... on ProjectV2ItemFieldTextValue {
                      text
                      field { ... on ProjectV2FieldCommon { name } }
                    }
                    ... on ProjectV2ItemFieldDateValue {
                      date
                      field { ... on ProjectV2FieldCommon { name } }
                    }
                  }
                }
              }
            }
          }
          EOF

          QUERY_DATA=$(gh api graphql -f query="$QUERY" -f item_id="$ITEM_ID")
          
          # Extract and clean new value
          RAW_NEW_VAL=$(echo "$QUERY_DATA" | jq -r --arg FIELD "$FIELD_NAME" '
            .data.node.fieldValues.nodes[] 
            | select(.field.name == $FIELD) 
            | (.name // .text // .date // "None")
          ')
          
          # Export to environment for next step
          echo "NEW_VAL_CLEAN=${RAW_NEW_VAL%%T*}" >> $GITHUB_ENV

      - name: Post Comment (as Bot)
        env:
          # Using GITHUB_TOKEN here changes the identity to github-actions[bot]
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ github.event.client_payload.content_node_id }}
          FIELD: ${{ github.event.client_payload.field_name }}
          OLD_VAL: ${{ github.event.client_payload.old_value }}
          USER_LOGIN: ${{ github.event.client_payload.changed_by }}
        run: |
          set -e
          
          # Final cleanup for the 'None' fallback
          FINAL_NEW="${NEW_VAL_CLEAN:-None}"
          OLD_CLEAN="${OLD_VAL%%T*}"
          FINAL_OLD="${OLD_CLEAN:-None}"
          [ "$FINAL_NEW" == "null" ] && FINAL_NEW="None"
          [ "$FINAL_OLD" == "null" ] && FINAL_OLD="None"

          COMMENT_BODY="ðŸ”„ **$USER_LOGIN** updated **$FIELD**: $FINAL_OLD â†’ **$FINAL_NEW**"

          gh api graphql -f query='
            mutation($subjectId: ID!, $body: String!) {
              addComment(input: {subjectId: $subjectId, body: $body}) { clientMutationId }
            }' -f subjectId="$ISSUE_ID" -f body="$COMMENT_BODY"
