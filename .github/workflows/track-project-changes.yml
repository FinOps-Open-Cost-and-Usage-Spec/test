name: Log Project Field Change
on:
  repository_dispatch:
    types: [project_field_updated]

jobs:
  comment_change:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch New Value
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          # Fetch the current (new) value of the field that changed
          gh api graphql -f query='
            query($item_id: ID!) {
              node(id: $item_id) {
                ... on ProjectV2Item {
                  fieldValues(first: 20) {
                    nodes {
                      ... on ProjectV2ItemFieldSingleSelectValue {
                        name
                        field { ... on ProjectV2FieldCommon { name } }
                      }
                    }
                  }
                }
              }
            }' -f item_id="${{ github.event.client_payload.item_node_id }}" > data.json

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
          OLD_VAL: ${{ github.event.client_payload.old_value }}
          NEW_VAL: ${{ github.event.client_payload.new_value }}
          FIELD: ${{ github.event.client_payload.field_name }}
          ISSUE_ID: ${{ github.event.client_payload.content_node_id }}
        run: |
          # Extract the NEW value from the JSON we just fetched
          # NEW_VAL=$(jq -r --arg FIELD "$FIELD" '.data.node.fieldValues.nodes[] | select(.field.name==$FIELD) | .name' data.json)
          
          # Create the comment body
          COMMENT_BODY="ðŸ”„ **Project Update:** Field '$FIELD' changed from **$OLD_VAL** to **$NEW_VAL**."
          
          # Post the comment to the Issue or PR
          gh api graphql -f query='
            mutation($subjectId: ID!, $body: String!) {
              addComment(input: {subjectId: $subjectId, body: $body}) {
                clientMutationId
              }
            }' -f subjectId="$ISSUE_ID" -f body="$COMMENT_BODY"
