name: Log Project Field Change
on:
  repository_dispatch:
    types: [project_field_updated]

jobs:
  comment_change:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch New Value
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          gh api graphql -f query='
            query($item_id: ID!) {
              node(id: $item_id) {
                ... on ProjectV2Item {
                  fieldValues(first: 20) {
                    nodes {
                      ... on ProjectV2ItemFieldSingleSelectValue {
                        name
                        field { ... on ProjectV2FieldCommon { name } }
                      }
                      ... on ProjectV2ItemFieldTextValue {
                        text
                        field { ... on ProjectV2FieldCommon { name } }
                      }
                      ... on ProjectV2ItemFieldDateValue {
                        date
                        field { ... on ProjectV2FieldCommon { name } }
                      }
                    }
                  }
                }
              }
            }' -f item_id="${{ github.event.client_payload.item_node_id }}" > data.json

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
          OLD_VAL: ${{ github.event.client_payload.old_value }}
          FIELD: ${{ github.event.client_payload.field_name }}
          ISSUE_ID: ${{ github.event.client_payload.content_node_id }}
        run: |
          # 1. Extract the NEW value from the fetched JSON
          RAW_NEW_VAL=$(jq -r --arg FIELD "$FIELD" '.data.node.fieldValues.nodes[] | select(.field.name == $FIELD) | (.name // .text // .date // "None")' data.json)

          # 2. Trim date section after "T" for both values
          # This works even if there is no "T" (like in a Status field)
          NEW_VAL_CLEAN="${RAW_NEW_VAL%%T*}"
          OLD_VAL_CLEAN="${OLD_VAL%%T*}"

          # 3. Create the comment body
          COMMENT_BODY="ðŸ”„ **Project Update:** Field '$FIELD' changed from **$OLD_VAL_CLEAN** to **$NEW_VAL_CLEAN**."

          # 4. Post the comment via GraphQL
          gh api graphql -f query='
            mutation($subjectId: ID!, $body: String!) {
              addComment(input: {subjectId: $subjectId, body: $body}) {
                clientMutationId
              }
            }' -f subjectId="$ISSUE_ID" -f body="$COMMENT_BODY"
