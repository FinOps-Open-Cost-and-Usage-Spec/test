name: Log Project Field Change
on:
  repository_dispatch:
    types: [project_field_updated]

jobs:
  comment_change:
    runs-on: ubuntu-latest
    steps:
      - name: Post Comment as Bot
        env:
          # Use GITHUB_TOKEN so the bot gets the credit
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ github.event.client_payload.content_node_id }}
          FIELD: ${{ github.event.client_payload.field_name }}
          OLD_VAL: ${{ github.event.client_payload.old_value }}
          NEW_VAL: ${{ github.event.client_payload.new_value }}
          USER_LOGIN: ${{ github.event.client_payload.changed_by }}
        run: |
          set -e

          # Build the comment body
          COMMENT_BODY="ðŸ”„ **$USER_LOGIN** updated **$FIELD**: $OLD_VAL â†’ **$NEW_VAL**"

          # Execute the mutation
          gh api graphql -f query='
            mutation($subjectId: ID!, $body: String!) {
              addComment(input: {subjectId: $subjectId, body: $body}) {
                clientMutationId
              }
            }' -f subjectId="$ISSUE_ID" -f body="$COMMENT_BODY"
