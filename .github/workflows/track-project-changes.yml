name: Log Project Field Change
on:
  repository_dispatch:
    types: [project_field_updated]

jobs:
  comment_change:
    runs-on: ubuntu-latest
    steps:
      - name: Update or Create Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ github.event.client_payload.content_node_id }}
          FIELD: ${{ github.event.client_payload.field_name }}
          OLD_VAL: ${{ github.event.client_payload.old_value }}
          NEW_VAL: ${{ github.event.client_payload.new_value }}
          USER_LOGIN: ${{ github.event.client_payload.changed_by }}
          ACTION_TYPE: ${{ github.event.client_payload.action_type }}
        run: |
          set -e

          # 0. GATEKEEPER: Prevent the logger from spamming thread count updates
          if [ "$FIELD" == "PR Open Threads" ]; then
            echo "Field '$FIELD' updated by automation. Skipping log entry to prevent spam."
            exit 0
          fi

          # 1. Fetch Metadata (Handles Project Item, Issue, or PR)
          QUERY_INFO=$(gh api graphql -f query='
            query($id: ID!) {
              node(id: $id) {
                ... on ProjectV2Item {
                  content {
                    ... on Issue { id createdAt }
                    ... on PullRequest { id createdAt }
                  }
                }
                ... on Issue { id createdAt }
                ... on PullRequest { id createdAt }
              }
            }' -f id="$ISSUE_ID")

          # 2. Extract Data Safely
          CREATED_AT=$(echo "$QUERY_INFO" | jq -r '.data.node.content.createdAt // .data.node.createdAt // ""')
          SUBJECT_ID=$(echo "$QUERY_INFO" | jq -r '.data.node.content.id // .data.node.id // ""')
          
          # Fallback to the original ID if GraphQL couldn't resolve a subject
          if [ -z "$SUBJECT_ID" ] || [ "$SUBJECT_ID" == "null" ]; then
            SUBJECT_ID="$ISSUE_ID"
          fi
          
          # 3. Calculate Age
          if [ -z "$CREATED_AT" ] || [ "$CREATED_AT" == "null" ]; then
            AGE_SECONDS=3600
          else
            CREATE_TS=$(date -d "$CREATED_AT" +%s)
            NOW_TS=$(date +%s)
            AGE_SECONDS=$(( NOW_TS - CREATE_TS ))
          fi

          # 4. Normalize Values
          NORM_OLD=$(echo "$OLD_VAL" | sed 's/null//g; s/None//g')
          ACTOR="${USER_LOGIN:-Automation}"

          # 5. Determine the Log Line
          if [ "$ACTION_TYPE" == "cleared" ]; then
              PREFIX="**$ACTOR** cleared"
              [ "$AGE_SECONDS" -lt 60 ] && PREFIX="**Cleared**"
              NEW_LINE="* $PREFIX **$FIELD**"
          else
            if [ "$NORM_OLD" == "$NEW_VAL" ]; then
              echo "No change detected. Skipping."
              exit 0
            fi

            # IF Item is brand new (< 60s), use "Initialized"
            if [ "$AGE_SECONDS" -lt 60 ]; then
               NEW_LINE="* **Initialized** **$FIELD**: **$NEW_VAL**"
            else
               # If it's an old item but the field was empty, show clean update
               if [ -z "$NORM_OLD" ]; then
                  NEW_LINE="* **$ACTOR** updated **$FIELD**: **$NEW_VAL**"
               else
                  NEW_LINE="* **$ACTOR** updated **$FIELD**: $OLD_VAL â†’ **$NEW_VAL**"
               fi
            fi
          fi

          # 6. Query for existing bot comments (last 20)
          QUERY_LATEST='query($id: ID!) { 
            node(id: $id) { 
              ... on Issue { comments(last: 20) { nodes { id body createdAt viewerDidAuthor } } }
              ... on PullRequest { comments(last: 20) { nodes { id body createdAt viewerDidAuthor } } }
            } 
          }'
          
          ALL_COMMENTS=$(gh api graphql -f query="$QUERY_LATEST" -f id="$SUBJECT_ID" --jq '.data.node.comments.nodes // []')
          
          # Look for a comment made by the bot in the last 5 minutes (300 seconds)
          RECENT_COMMENT=$(echo "$ALL_COMMENTS" | jq -c 'reverse | .[] | select(.viewerDidAuthor == true) | select((now - (.createdAt | fromdateiso8601)) < 300)' | head -n 1 || echo "")

          # 7. Append or Create Comment
          if [ -n "$RECENT_COMMENT" ]; then
            COMMENT_ID=$(echo "$RECENT_COMMENT" | jq -r '.id')
            EXISTING_BODY=$(echo "$RECENT_COMMENT" | jq -r '.body')
            UPDATED_BODY=$(printf "%s\n%s" "$EXISTING_BODY" "$NEW_LINE")
            
            gh api graphql -f query='mutation($id: ID!, $body: String!) { updateIssueComment(input: { id: $id, body: $body }) { clientMutationId } }' -f id="$COMMENT_ID" -f body="$UPDATED_BODY"
          else
            NEW_BODY=$(printf "ðŸ”„ **Project Update**\n%s" "$NEW_LINE")
            gh api graphql -f query='mutation($subject: ID!, $body: String!) { addComment(input: { subjectId: $subject, body: $body }) { clientMutationId } }' -f subject="$SUBJECT_ID" -f body="$NEW_BODY"
          fi
