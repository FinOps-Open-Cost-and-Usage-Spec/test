name: Log Project Field Change
on:
  repository_dispatch:
    types: [project_field_updated]

jobs:
  comment_change:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch New Value
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          # Fetching the current state of the item to get the "New Value"
          gh api graphql -f query='
            query($item_id: ID!) {
              node(id: $item_id) {
                ... on ProjectV2Item {
                  fieldValues(first: 20) {
                    nodes {
                      ... on ProjectV2ItemFieldSingleSelectValue {
                        name
                        field { ... on ProjectV2FieldCommon { name } }
                      }
                      ... on ProjectV2ItemFieldTextValue {
                        text
                        field { ... on ProjectV2FieldCommon { name } }
                      }
                      ... on ProjectV2ItemFieldDateValue {
                        date
                        field { ... on ProjectV2FieldCommon { name } }
                      }
                    }
                  }
                }
              }
            }' -f item_id="${{ github.event.client_payload.item_node_id }}" > data.json

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLD_VAL: "${{ github.event.client_payload.old_value }}"
          FIELD: "${{ github.event.client_payload.field_name }}"
          ISSUE_ID: "${{ github.event.client_payload.content_node_id }}"
          USER_LOGIN: "${{ github.event.client_payload.changed_by }}"
        run: |
          # 1. Extract the NEW value from the JSON using jq
          # It checks for .name (Select), .text (Text), or .date (Date)
          RAW_NEW_VAL=$(jq -r --arg FIELD "$FIELD" '
            .data.node.fieldValues.nodes[] 
            | select(.field.name == $FIELD) 
            | (.name // .text // .date // "None")
          ' data.json)

          # 2. Trim date section after "T" for both Old and New values
          # This keeps the comment clean (e.g., 2026-01-23 instead of 2026-01-23T00:00:00Z)
          NEW_VAL_CLEAN="${RAW_NEW_VAL%%T*}"
          OLD_VAL_CLEAN="${OLD_VAL%%T*}"

          # 3. Create the comment body
          # Attributing the change to the user who performed it in the project
          COMMENT_BODY="ðŸ”„ **$USER_LOGIN** updated **$FIELD**: ~~$OLD_VAL_CLEAN~~ â†’ **$NEW_VAL_CLEAN**"

          # 4. Post the comment via GraphQL mutation
          gh api graphql -f query='
            mutation($subjectId: ID!, $body: String!) {
              addComment(input: {subjectId: $subjectId, body: $body}) {
                clientMutationId
              }
            }' -f subjectId="$ISSUE_ID" -f body="$COMMENT_BODY"
