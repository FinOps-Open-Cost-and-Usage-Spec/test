name: Log Project Field Change

on:
  repository_dispatch:
    types: [project_field_updated]

jobs:
  comment_change:
    runs-on: ubuntu-latest
    steps:
      - name: Update or Create Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ github.event.client_payload.content_node_id }}
          FIELD: ${{ github.event.client_payload.field_name }}
          OLD_VAL: ${{ github.event.client_payload.old_value }}
          NEW_VAL: ${{ github.event.client_payload.new_value }}
          USER_LOGIN: ${{ github.event.client_payload.changed_by }}
          ACTION_TYPE: ${{ github.event.client_payload.action_type }}
        run: |
          set -e

          # 1. Fetch Metadata safely (Checks both Issue and PR types)
          QUERY_INFO=$(gh api graphql -f query='
            query($id: ID!) {
              node(id: $id) {
                ... on Issue { createdAt }
                ... on PullRequest { createdAt }
              }
            }' -f id="$ISSUE_ID")

          # Extract date; use empty string if not found to prevent "null" string
          CREATED_AT=$(echo "$QUERY_INFO" | jq -r '.data.node.createdAt // ""')
          
          # 2. Safety check for date to prevent the 'invalid date null' error
          if [ -z "$CREATED_AT" ] || [ "$CREATED_AT" == "null" ]; then
            echo "Warning: Could not resolve createdAt for $ISSUE_ID. Defaulting to 0."
            AGE_SECONDS=3600 # Fallback: treat as an old issue
          else
            CREATE_TS=$(date -d "$CREATED_AT" +%s)
            NOW_TS=$(date +%s)
            AGE_SECONDS=$(( NOW_TS - CREATE_TS ))
          fi

          # 3. Determine if this is an Initialization or a Manual Update
          if [ "$AGE_SECONDS" -lt 60 ]; then
            PREFIX="**Initialized**"
          else
            ACTOR="${USER_LOGIN:-Automation}"
            PREFIX="**$ACTOR** updated"
          fi

          # 4. Define the new log line
          if [ "$ACTION_TYPE" == "cleared" ]; then
             [ "$AGE_SECONDS" -lt 60 ] && PREFIX="**Cleared**"
             NEW_LINE="* $PREFIX **$FIELD**"
          else
            # Skip if no actual value change detected
            if [ "$OLD_VAL" == "$NEW_VAL" ] && [ -n "$OLD_VAL" ]; then
              echo "No change detected. Skipping."
              exit 0
            fi
            
            # Format: Old -> New (Handling empty old values)
            if [ -z "$OLD_VAL" ] || [ "$OLD_VAL" == "null" ]; then
              NEW_LINE="* $PREFIX **$FIELD**: **$NEW_VAL**"
            else
              NEW_LINE="* $PREFIX **$FIELD**: $OLD_VAL â†’ **$NEW_VAL**"
            fi
          fi

          # 5. Query for existing bot comments (checks PullRequest and Issue)
          QUERY_LATEST='query($id: ID!) { 
            node(id: $id) { 
              ... on Issue { comments(last: 20) { nodes { id body createdAt viewerDidAuthor } } }
              ... on PullRequest { comments(last: 20) { nodes { id body createdAt viewerDidAuthor } } }
            } 
          }'
          
          ALL_COMMENTS=$(gh api graphql -f query="$QUERY_LATEST" -f id="$ISSUE_ID" --jq '.data.node.comments.nodes // []')
          
          # 6. Identify a 'recent' bot comment (within 5 minutes) to append to
          RECENT_COMMENT=$(echo "$ALL_
