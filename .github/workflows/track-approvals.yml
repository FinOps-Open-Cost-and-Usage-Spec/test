name: Sync Approval Count to Project

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  pull_request_review:
    types: [submitted, edited, dismissed]
  issue_comment:
    types: [created]

jobs:
  sync_approvals:
    # IMPORTANT: Only run for actual PRs (issue_comment triggers for both Issues and PRs)
    if: github.event.issue.pull_request || github.event.pull_request
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PROJECT_PAT }}
      ORG: "your-org-name" # Ensure this is your actual Org name or Username
      PROJECT_NUM: 1
      # This logic handles both PR events and Comment events to get the URL
      PR_URL: ${{ github.event.pull_request.html_url || github.event.issue.pull_request.html_url }}

    steps:
      - name: Calculate and Update Approvals
        run: |
          set -e

          # 1. Get the count of unique "APPROVED" reviews
          APPROVAL_COUNT=$(gh pr view "$PR_URL" --json reviews | \
            jq '.reviews | group_by(.author.login) | map(select(.[-1].state == "APPROVED")) | length')
          
          echo "Current Unique Approvals: $APPROVAL_COUNT"

          # 2. Get Project Data
          # We add --owner-type to resolve the "unknown owner type" error
          # If ORG is a person, use "user". If it is a GitHub Org, use "organization".
          OWNER_TYPE="organization" 

          # 3. Get the Project ID and Item ID
          # We combine these to reduce CLI calls and pinpoint the error
          PROJECT_DATA=$(gh project view $PROJECT_NUM --owner "$ORG" --owner-type "$OWNER_TYPE" --format json)
          PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.id')
          
          ITEM_ID=$(gh project item-list $PROJECT_NUM --owner "$ORG" --owner-type "$OWNER_TYPE" --format json | \
                    jq -r ".items[] | select(.content.url == \"$PR_URL\") | .id")

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" == "null" ]; then
            echo "PR not found in Project. Attempting to add it..."
            ITEM_ID=$(gh project item-add $PROJECT_NUM --owner "$ORG" --owner-type "$OWNER_TYPE" --url "$PR_URL" --format json | jq -r '.id')
          fi

          # 4. Update the 'Approvals' field
          # Note: If you couldn't set it to 'Number', change --number to --text below
          gh project item-edit \
            --id "$ITEM_ID" \
            --project-id "$PROJECT_ID" \
            --field "Approvals" \
            --number "$APPROVAL_COUNT"
          
          echo "Successfully updated Approvals to $APPROVAL_COUNT"
