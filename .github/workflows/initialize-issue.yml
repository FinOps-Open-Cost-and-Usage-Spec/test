name: Initialize Project Fields
on:
  issues:
    types: [opened]

jobs:
  setup_issue_in_project:
    runs-on: ubuntu-latest
    steps:
      - name: Add to Project, Set AI Status, and Inherit Task Force
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
          ORG: "FinOps-Open-Cost-and-Usage-Spec"
          PRJ_NUM: 7
        run: |
          set -e

          # 1. Fetch the Child's Parent ID and Project Metadata
          echo "Identifying Parent Issue..."
          INITIAL_DATA=$(gh api graphql -f query='
            query($issue_id: ID!, $org: String!, $num: Int!) {
              organization(login: $org) {
                projectV2(number: $num) {
                  id
                  ai_field: field(name: "AI Status") { ... on ProjectV2SingleSelectField { id options { id name } } }
                  tf_field: field(name: "Task Force") { ... on ProjectV2SingleSelectField { id } }
                }
              }
              node(id: $issue_id) {
                ... on Issue {
                  trackedInIssues(first: 1) { nodes { id } }
                }
              }
            }' -f issue_id="${{ github.event.issue.node_id }}" -f org="$ORG" -F num=$PRJ_NUM)

          PRJ_ID=$(echo "$INITIAL_DATA" | jq -r '.data.organization.projectV2.id')
          PARENT_ISSUE_ID=$(echo "$INITIAL_DATA" | jq -r '.data.node.trackedInIssues.nodes[0].id // empty')
          AI_FIELD_ID=$(echo "$INITIAL_DATA" | jq -r '.data.organization.projectV2.ai_field.id')
          AI_OPEN_ID=$(echo "$INITIAL_DATA" | jq -r '.data.organization.projectV2.ai_field.options[] | select(.name=="Open") | .id')
          TF_FIELD_ID=$(echo "$INITIAL_DATA" | jq -r '.data.organization.projectV2.tf_field.id')

          # 2. Add Child to Project
          echo "Adding child to project..."
          ITEM_ID=$(gh api graphql -f query='
            mutation($project: ID!, $issue: ID!) {
              addProjectV2ItemById(input: {projectId: $project, contentId: $issue}) { item { id } }
            }' -f project="$PRJ_ID" -f issue="${{ github.event.issue.node_id }}" --jq '.data.addProjectV2ItemById.item.id')

          # 3. Set AI Status to Open
          gh api graphql -f query='
            mutation($project: ID!, $item: ID!, $field: ID!, $option: String!) {
              updateProjectV2ItemFieldValue(input: { projectId: $project, itemId: $item, fieldId: $field, value: { singleSelectOptionId: $option } }) { projectV2Item { id } }
            }' -f project="$PRJ_ID" -f item="$ITEM_ID" -f field="$AI_FIELD_ID" -f option="$AI_OPEN_ID"

          # 4. If Parent exists, fetch its Task Force value directly
          if [ -n "$PARENT_ISSUE_ID" ]; then
            echo "Parent found ($PARENT_ISSUE_ID). Fetching Task Force value..."
            
            PARENT_DATA=$(gh api graphql -f query='
              query($parent_id: ID!, $num: Int!) {
                node(id: $parent_id) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        project { number }
                        fieldValueByName(name: "Task Force") {
                          ... on ProjectV2ItemFieldSingleSelectValue { optionId }
                        }
                      }
                    }
                  }
                }
              }' -f parent_id="$PARENT_ISSUE_ID" -F num=$PRJ_NUM)

            PARENT_TF_OPTION_ID=$(echo "$PARENT_DATA" | jq -r --argjson NUM "$PRJ_NUM" '.data.node.projectItems.nodes[] | select(.project.number == $NUM) | .fieldValueByName.optionId // empty')

            if [ -n "$PARENT_TF_OPTION_ID" ] && [ "$PARENT_TF_OPTION_ID" != "null" ]; then
              echo "Inheriting Task Force..."
              gh api graphql -f query='
                mutation($project: ID!, $item: ID!, $field: ID!, $option: String!) {
                  updateProjectV2ItemFieldValue(input: { projectId: $project, itemId: $item, fieldId: $field, value: { singleSelectOptionId: $option } }) { projectV2Item { id } }
                }' -f project="$PRJ_ID" -f item="$ITEM_ID" -f field="$TF_FIELD_ID" -f option="$PARENT_TF_OPTION_ID"
            else
              echo "Parent has no Task Force value set."
            fi
          else
            echo "No parent issue linked."
          fi
